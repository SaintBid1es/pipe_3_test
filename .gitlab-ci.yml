stages:
  - validate
  - test

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"
  GIT_STRATEGY: clone
  VENV_PATH: "$CI_PROJECT_DIR/.venv"

build-check:
  stage: validate
  image: maven:3.9-eclipse-temurin-17
  script:
    - echo "Проверка сборки проекта"
    - mvn $MAVEN_CLI_OPTS clean compile
    - echo "Сборка проекта успешна"

lint-checkstyle:
  stage: validate
  image: maven:3.9-eclipse-temurin-17
  script:
    - echo "Проверка синтаксических ошибок линтером"
    - mvn $MAVEN_CLI_OPTS checkstyle:check
    - echo "Проверка линтером завершена"
  artifacts:
    reports:
      checkstyle: target/checkstyle-result.xml

test-execution:
  stage: test
  image: maven:3.9-eclipse-temurin-17
  script:
    - echo "Запуск тестов"
    - mvn $MAVEN_CLI_OPTS test
    - echo "Все тесты выполнены успешно"
  artifacts:
    reports:
      junit: target/surefire-reports/TEST-*.xml

config-validation:
  stage: test
  image: maven:3.9-eclipse-temurin-17
  services:
    - postgres:15-alpine
  variables:
    POSTGRES_DB: test_db
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    POSTGRES_HOST_AUTH_METHOD: trust
  before_script:
    - apt-get update -qq && apt-get install -y -qq python3 python3-venv python3-pip netcat-openbsd
    - python3 -m venv $VENV_PATH
    - source $VENV_PATH/bin/activate
    - pip install --upgrade pip
    - pip install pyyaml
  script:
    - echo "Проверка валидности конфигурации Spring Boot"
    - mvn $MAVEN_CLI_OPTS validate
    - source $VENV_PATH/bin/activate
    - python3 -c "import yaml; yaml.safe_load(open('src/main/resources/application.yml'))"
    - echo "Запуск Spring Boot приложения для проверки конфигурации"
    - mvn $MAVEN_CLI_OPTS spring-boot:run -Dspring-boot.run.arguments="--spring.profiles.active=test --server.port=8888 --spring.datasource.url=jdbc:postgresql://postgres:5432/test_db --spring.datasource.username=postgres --spring.datasource.password=postgres --spring.jpa.hibernate.ddl-auto=create" &
    - sleep 20
    - nc -z localhost 8888 || exit 1
    - echo "Конфигурация Spring Boot валидна, приложение успешно запущено"
