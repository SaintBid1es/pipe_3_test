stages:
  - validate
  - test

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"
  GIT_STRATEGY: clone

default:
  before_script:
    - chmod +x mvnw 2>/dev/null || true
    - export JAVA_HOME=$(java -XshowSettings:properties -version 2>&1 | sed -n 's/ *java\.home = *//p') || true
    - if [ -z "$JAVA_HOME" ] && [ -d /usr/lib/jvm ]; then for d in /usr/lib/jvm/java-17* /usr/lib/jvm/default-java; do [ -d "$d" ] && export JAVA_HOME="$d" && break; done; fi

build-check:
  stage: validate
  script:
    - ./mvnw $MAVEN_CLI_OPTS clean compile

lint-checkstyle:
  stage: validate
  script:
    - ./mvnw $MAVEN_CLI_OPTS checkstyle:check

test-execution:
  stage: test
  script:
    - ./mvnw $MAVEN_CLI_OPTS test

config-validation:
  stage: test
  script:
    - ./mvnw $MAVEN_CLI_OPTS validate
    - python3 -c "import yaml; yaml.safe_load(open('src/main/resources/application.yml'))" || true
