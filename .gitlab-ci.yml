stages:
  - validate
  - test

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"
  GIT_STRATEGY: clone
  VENV_PATH: "$CI_PROJECT_DIR/.venv"


.install_java_maven:
  before_script:
    - chmod +x mvnw 2>/dev/null || true
    - |
      if [ -z "$JAVA_HOME" ] && command -v java >/dev/null 2>&1; then
        export JAVA_HOME=$(dirname $(dirname $(readlink -f $(which java))))
      fi
    - java -version || true

build-check:
  stage: validate
  extends: .install_java_maven
  script:
    - echo "Проверка сборки проекта"
    - ./mvnw $MAVEN_CLI_OPTS clean compile
    - echo "Сборка проекта успешна"

lint-checkstyle:
  stage: validate
  extends: .install_java_maven
  script:
    - echo "Проверка синтаксических ошибок линтером"
    - ./mvnw $MAVEN_CLI_OPTS checkstyle:check
    - echo "Проверка линтером завершена"

test-execution:
  stage: test
  extends: .install_java_maven
  script:
    - echo "Запуск тестов"
    - ./mvnw $MAVEN_CLI_OPTS test
    - echo "Все тесты выполнены успешно"

config-validation:
  stage: test
  extends: .install_java_maven
  script:
    - echo "Проверка валидности конфигурации Spring Boot"
    - ./mvnw $MAVEN_CLI_OPTS validate
    - |
      if command -v python3 >/dev/null 2>&1; then
        python3 -c "import yaml; yaml.safe_load(open('src/main/resources/application.yml'))" || true
      fi
    - echo "Конфигурация Spring Boot валидна"